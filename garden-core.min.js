(function(e,t){typeof exports=="object"?module.exports=t(require("async"),require("couchr"),require("url")):typeof define=="function"&&define.amd?define(["async","couchr","url"],t):e.garden_core=t(e.async,e.couchr,e.url)})(this,function(e,t,n){function i(e,t){return e.headers?e.headers.etag.replace(/"/gi,""):e.getResponseHeader("etag").replace(/"/gi,"")}function s(e,t){return e.indexOf(t,e.length-t.length)!==-1}var r={};r.std_options={dashboard_db_name:"dashboard",install_with_no_reader:!1,additional_member_roles:[],app_details:{},update_status_function:function(e,t){},add_vhost_entries:!1,vhost_hostnames:[],vhost_path:null},r.install_market=function(e,t,n,i,s){i.app_details=e,i.vhost_path="/"+n+"/_design/"+e.doc_id+"/"+e.open_path,r.install(e.db_src,e.doc_id,t,n,i,s)},r.install=function(t,i,o,u,a,f){f||(f=a),s(o,"/")||(o+="/");var l=r.process_options(a),c=n.resolve(o,l.dashboard_db_name),h,p=n.resolve(o,u);l.update_status_function("Installing App","30%"),e.series([function(e){r.gather_current_settings(p,"_design/"+i,function(t,n){return h=n,e()})},function(e){r.replicate(o,t,u,i,e)},function(e){r.verify_doc_exists(p,i,e)},function(e){l.update_status_function("Configuring App","60%"),r.copyDoc(p,i,"_design/"+i,!0,e)},function(e){r.apply_settings(p,"_design/"+i,h,e)},function(e){l.update_status_function("Cleaning Up","70%"),r.purgeDoc(p,i,e)},function(e){l.update_status_function("Recording Install","85%"),r.saveAppDetails(c,u,l.app_details,e)},function(e){l.update_status_function("Setting security","90%",!0),r.install_app_security(p,l,e)},function(e){l.update_status_function("Configuring URL","98%",!0);if(!l.add_vhost_entries)return e(null);r.install_app_vhosts(o,l.vhost_hostnames,l.vhost_short_name,l.vhost_path,e)}],function(e){e||l.update_status_function("Install Complete","100%",!0),f(e)})},r.replicate=function(e,r,i,s,o){var u=n.resolve(e,"/_replicate"),a={source:r,target:i,create_target:!0,doc_ids:[s]};t.post(u,a,o)},r.verify_doc_exists=function(e,r,i){s(e,"/")||(e+="/");var o=n.resolve(e,r);t.head(o,function(e,t,n){if(e)return e.response&&e.response.statusCode===404?i("App has not been updated, install aborting"):i(e);i(null)})},r.copyDoc=function(e,r,o,u,a){s(e,"/")||(e+="/");var f=n.resolve(e,r),l=n.resolve(e,o),c=o;if(!u)return t.copy(f,c,a);t.head(l,function(e,n,r){if(e)return e.response&&e.response.statusCode===404?t.copy(f,c,a):a(e);var s=i(r);return c+="?rev="+s,t.copy(f,c,a)})},r.purgeDoc=function(e,r,o){s(e,"/")||(e+="/");var u=n.resolve(e,r),a=n.resolve(e,"./_purge");t.head(u,function(e,n,s){if(e)return o(e);var u=i(s,n),f={};f[r]=[u],t.post(a,f,o)})},r.saveAppDetails=function(e,r,i,o){s(e,"/")||(e+="/"),o||(o=i,i=null),i||(i={}),i.installed={date:(new Date).getTime(),db:r},i.dashboard_title=r,i.type="install";if(!i._id)t.post(e,i,o);else{var u=n.resolve(e,i._id);t.put(u,i,o)}},r.install_app_security=function(e,t,n){n||(n=t,t=null),t||(t={install_with_no_reader:!1});if(t.install_with_no_reader)return n(null);var i=["_admin"];t.additional_member_roles&&t.additional_member_roles.length>0&&(i=i.concat(t.additional_member_roles)),r.setDBReaderRoles(e,i,n)},r.install_member_roles=function(e,t){r.addDBReaderUser(db_name,install_doc.remote_user,function(e){callback(e,install_doc)})},r.getDBSecurity=function(e,r){s(e,"/")||(e+="/");var i=n.resolve(e,"./_security");t.get(i,r)},r.setDBSecurity=function(e,r,i){s(e,"/")||(e+="/");var o=n.resolve(e,"./_security");t.put(o,r,i)},r.setDBReaderRoles=function(e,t,n){r.getDBSecurity(e,function(i,s){if(!s||!s.admins)s={admins:{names:[],roles:[]},members:{names:[],roles:[]}};o(t)?s.members.roles=t:s.members.roles=[t],r.setDBSecurity(e,s,n)})},r.addDBReaderUser=function(e,t,n){r.getDBSecurity(e,function(r,i){if(!i||!i.admins)i={admins:{names:[],roles:[]},members:{names:[],roles:[]}};o(t)?i.members.names=_.union(i.members.names,t):i.members.names.push(t),setDBSecurity(e,i,n)})},r.addDBReaderRole=function(e,t,n){r.getDBSecurity(e,function(r,i){if(!i||!i.admins)i={admins:{names:[],roles:[]},members:{names:[],roles:[]}};_.isArray(t)?i.members.roles=_.union(i.members.roles,t):i.members.roles.push(t),setDBSecurity(e,i,n)})},r.onlyAdminDBReaderRole=function(e,t){r.getDBSecurity(e,function(n,r){if(n)return t(n);if(!r||!r.admins)r={admins:{names:[],roles:[]},members:{names:[],roles:[]}};r.members.roles=["_admin"],setDBSecurity(e,r,t)})},r.removeAllDBReaderRoles=function(e,t){r.getDBSecurity(e,function(n,r){if(n)return t(n);r.admins||(r={admins:{names:[],roles:[]},members:{names:[],roles:[]}}),r.members.roles=[],setDBSecurity(e,r,t)})},r.removeDBReaderRole=function(e,t,n){r.getDBSecurity(e,function(r,i){if(r)return n(r);i.admins||(i={admins:{names:[],roles:[]},members:{names:[],roles:[]}}),i.members.roles=_.without(i.members.roles,t),setDBSecurity(e,i,n)})},r.install_app_vhosts=function(t,i,f,l,c){s(t,"/")||(t+="/");var h=[];o(i)?h=i:h=i.split(","),e.forEach(h,function(e,i){var s=n.parse(e),o=s.hostname;s.port!="80"&&(a(s.port)||u(s.port))&&(o+=":"+s.port),r.addVhostRule(t,o,f,l,i)},c)},r.addVhostRule=function(e,r,i,o,u){s(e,"/")||(e+="/");var a="./_config/"+r+"/"+i,f=n.resolve(e,a);t.put(f,o,u)},r.process_options=function(e){if(!e)return r.std_options;var t={dashboard_db_name:e.dashboard_db_name||r.std_options.dashboard_db_name,install_with_no_reader:e.install_with_no_reader||r.std_options.install_with_no_reader,additional_member_roles:e.additional_member_roles||r.std_options.additional_member_roles,add_vhost_entries:e.add_vhost_entries||r.std_options.add_vhost_entries,vhost_hostnames:e.vhost_hostnames||r.std_options.vhost_hostnames,vhost_short_name:e.vhost_short_name||r.std_options.vhost_short_name,vhost_path:e.vhost_path||r.std_options.vhost_path,update_status_function:e.update_status_function||r.std_options.update_status_function};return t},r.gather_current_settings=function(e,r,i){var s=n.resolve(e,r);t.get(s,function(e,t){if(e)return i(e);i(null,t.app_settings)})},r.apply_settings=function(e,r,i,s){if(!i)return s(null);var o=n.resolve(e,r);t.get(o,function(e,n){if(e)return s(e);n.app_settings=i,t.put(o,n,s)})};var o=Array.isArray||function(e){return toString.call(e)=="[object Array]"},u=function(e){return toString.call(e)=="[object Number]"},a=function(e){return toString.call(e)=="[object String]"};return t.test?r:{install:r.install}});
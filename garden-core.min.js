(function(e,t){typeof exports=="object"?module.exports=t(require("async"),require("couchr"),require("url")):typeof define=="function"&&define.amd?define(["async","couchr","url"],t):e.returnExports=t(e.async,e.couchr)})(this,function(e,t,n){function i(e,t){return e.indexOf(t,e.length-t.length)!==-1}var r={};r.std_options={dashboard_db_name:"dashboard",install_with_no_reader:!1,additional_member_roles:[],app_details:{},update_status_function:function(e,t){},add_vhost_entries:!1,vhost_hostnames:[],vhost_path:null},r.install_market=function(e,t,n,i,s){i.app_details=e,i.vhost_path="/"+n+"/_design/"+e.doc_id+"/"+e.open_path,r.install(e.db_src,e.doc_id,t,n,i,s)},r.install=function(t,n,s,o,u,a){a||(a=u),i(s,"/")||(s+="/");var f=process_options(u),l=resolve(s,f.dashboard_db_name);couch_db_url=resolve(s,o),f.update_status_function("Installing App","30%"),e.waterfall([function(e){r.replicate(s,t,o,n,e)},function(e){f.update_status_function("Configuring App","60%"),r.copyDoc(couch_db_url,n,"_design/"+n,!1,e)},function(e){f.update_status_function("Cleaning Up","70%"),r.purgeDoc(couch_db_url,n,e)},function(e){f.update_status_function("Recording Install","85%"),r.saveAppDetails(l,o,f.app_details,e)},function(e){f.update_status_function("Setting security","90%",!0),r.install_app_security(couch_db_url,f,e)},function(e){f.update_status_function("Configuring URL","98%",!0);if(!f.add_vhost_entries)return e(null);r.install_app_vhosts(s,f.vhost_hostnames,f.vhost_short_name,f.vhost_path,e)}],function(e){f.update_status_function("Install Complete","100%",!0),a(e)})},r.replicate=function(e,r,i,s,o){var u=n.resolve(e,"/_replicate"),a={source:r,target:i,create_target:!0,doc_ids:[s]};t.post(u,a,o)},r.copyDoc=function(e,r,s,o,u){i(e,"/")||(e+="/");var a=n.resolve(e,r),f=s;if(!o)return t.copy(a,f,u);t.head(a,function(e,n,r){if(e)return u(e);var i=r.headers.etag.replace(/"/gi,"");return f+="?rev="+i,t.copy(a,f,u)})},r.purgeDoc=function(e,r,s){i(e,"/")||(e+="/");var o=n.resolve(e,r),u=n.resolve(e,"./_purge");t.head(o,function(e,n,i){if(e)return s(e);var o=i.headers.etag.replace(/"/gi,""),a={};a[r]=[o],t.post(u,a,s)})},r.saveAppDetails=function(e,r,s,o){i(e,"/")||(e+="/"),o||(o=s,s=null),s||(s={}),s.installed={date:(new Date).getTime(),db:r},s.dashboard_title=r,s.type="install";if(!s._id)t.post(e,s,o);else{var u=n.resolve(e,s._id);t.put(u,s,o)}},r.install_app_security=function(e,t,n){n||(n=t,t=null),t||(t={install_with_no_reader:!1});if(t.install_with_no_reader)return n(null);var i=["_admin"];t.additional_member_roles&&t.additional_member_roles.length>0&&(i=i.concat(t.additional_member_roles)),r.setDBReaderRoles(e,i,n)},r.install_member_roles=function(e,t){r.addDBReaderUser(db_name,install_doc.remote_user,function(e){callback(e,install_doc)})},r.getDBSecurity=function(e,r){i(e,"/")||(e+="/");var s=n.resolve(e,"./_security");t.get(s,r)},r.setDBSecurity=function(e,r,s){i(e,"/")||(e+="/");var o=n.resolve(e,"./_security");t.put(o,r,s)},r.setDBReaderRoles=function(e,t,n){r.getDBSecurity(e,function(i,o){if(!o||!o.admins)o={admins:{names:[],roles:[]},members:{names:[],roles:[]}};s(t)?o.members.roles=t:o.members.roles=[t],r.setDBSecurity(e,o,n)})},r.addDBReaderUser=function(e,t,n){r.getDBSecurity(e,function(r,i){if(!i||!i.admins)i={admins:{names:[],roles:[]},members:{names:[],roles:[]}};s(t)?i.members.names=_.union(i.members.names,t):i.members.names.push(t),setDBSecurity(e,i,n)})},r.addDBReaderRole=function(e,t,n){r.getDBSecurity(e,function(r,i){if(!i||!i.admins)i={admins:{names:[],roles:[]},members:{names:[],roles:[]}};_.isArray(t)?i.members.roles=_.union(i.members.roles,t):i.members.roles.push(t),setDBSecurity(e,i,n)})},r.onlyAdminDBReaderRole=function(e,t){r.getDBSecurity(e,function(n,r){if(n)return t(n);if(!r||!r.admins)r={admins:{names:[],roles:[]},members:{names:[],roles:[]}};r.members.roles=["_admin"],setDBSecurity(e,r,t)})},r.removeAllDBReaderRoles=function(e,t){r.getDBSecurity(e,function(n,r){if(n)return t(n);r.admins||(r={admins:{names:[],roles:[]},members:{names:[],roles:[]}}),r.members.roles=[],setDBSecurity(e,r,t)})},r.removeDBReaderRole=function(e,t,n){r.getDBSecurity(e,function(r,i){if(r)return n(r);i.admins||(i={admins:{names:[],roles:[]},members:{names:[],roles:[]}}),i.members.roles=_.without(i.members.roles,t),setDBSecurity(e,i,n)})},r.install_app_vhosts=function(t,a,f,l,c){i(t,"/")||(t+="/");var h=[];s(a)?h=a:h=a.split(","),e.forEach(h,function(e,i){var s=n.parse(e),a=s.hostname;s.port!="80"&&(u(s.port)||o(s.port))&&(a+=":"+s.port),r.addVhostRule(t,a,f,l,i)},c)},r.addVhostRule=function(e,r,s,o,u){i(e,"/")||(e+="/");var a="./_config/"+r+"/"+s,f=n.resolve(e,a);t.put(f,o,u)},r.process_options=function(e){if(!e)return r.std_options;var t={dashboard_db_name:e.dashboard_db_name||r.std_options.dashboard_db_name,install_with_no_reader:e.install_with_no_reader||r.std_options.install_with_no_reader,additional_member_roles:e.additional_member_roles||r.std_options.additional_member_roles,add_vhost_entries:e.add_vhost_entries||r.std_options.add_vhost_entries,vhost_hostnames:e.vhost_hostnames||r.std_options.vhost_hostnames,vhost_short_name:e.vhost_short_name||r.std_options.vhost_short_name,vhost_path:e.vhost_path||r.std_options.vhost_path};return t};var s=Array.isArray||function(e){return toString.call(e)=="[object Array]"},o=function(e){return toString.call(e)=="[object Number]"},u=function(e){return toString.call(e)=="[object String]"};return t.test?r:{install:r.install}});